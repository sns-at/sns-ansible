- name: Manage local users + SSH keys
  hosts: all
  become: true

  tasks:
    - name: Ensure shared write group exists (GitHub)
      ansible.builtin.group:
        name: "{{ github_write_group }}"
        state: present

    - name: Ensure users exist
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: /bin/bash
        create_home: true
        groups: "{{ item.groups | default([]) }}"
        append: true
        state: present
      loop: "{{ managed_users }}"

    - name: Allow passwordless sudo for managed users
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ item.name }}"
        content: "{{ item.name }} ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: "0440"
      loop: "{{ managed_users }}"
      when: "'sudo' in (item.groups | default([]))"

    - name: Ensure .ssh dir exists
      ansible.builtin.file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0700"
      loop: "{{ managed_users }}"

    - name: Install authorized_keys
      ansible.posix.authorized_key:
        user: "{{ item.name }}"
        key: "{{ lookup('file', playbook_dir ~ '/../' ~ item.pubkey_file) }}"
        state: present
      loop: "{{ managed_users }}"

    # OPTIONAL: disable password for these users (forces key-based login)
    - name: Lock password (optional)
      ansible.builtin.user:
        name: "{{ item.name }}"
        password_lock: true
      loop: "{{ managed_users }}"

    - name: Ensure shared directory exists (root-owned, group-writable)
      ansible.builtin.file:
        path: "{{ shared_github_dir }}"
        state: directory
        owner: root
        group: "{{ github_write_group }}"
        mode: "{{ shared_github_dir_mode }}"
        recurse: false
